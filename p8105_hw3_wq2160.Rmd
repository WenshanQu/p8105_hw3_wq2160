---
title: "p8105_hw3_wq2160"
author: "Wenshan Qu (wq2160)"
date: "10/18/2021"
output: github_document
---

```{r, include=FALSE}
library(tidyverse)
```

Initial Display Settings

```{r}
knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

load the `instacart` data.

```{r}
library(p8105.datasets)
data("instacart")
```


**Description**

This data set contains `nrow(distinct(instacart, order_id))` orders information, with `nrow(instacart)` rows and `ncol(instacart)` columns. The key variables in this data set including `names(instacart)`. 

To give a simple example on how to illustrate this chart, we could take the `ins_eg = filter(instacart, order_id == "1") `. For this order, number of `nrow(ins_eg)` items was purchased, with item names  `pull(ins_eg, product_name)` and item id `pull(ins_eg, product_id)`. For these items, the aisle_id, department_id and aisle name were provided to locate the product. Also, we can get the information fo the customer purchase behavior, such as the order these items were added to the cart, purchase time, times and intervals of reordering each item.

**1.1 Aisle information**

```{r}
instacart %>% 
  count(aisle) %>% 
    arrange(desc(n))
```

There are 134 aisles, and the most items are ordered from the **fresh vegetables** aisle. "fresh fruits", "packaged vegetables fruits" and "yogurt" are also popular aisles.

**1.2 Aisle plot**

```{r}
instacart %>% 
  count(aisle) %>% 
  filter(n > 10000) %>% 
  mutate(
    aisle = factor(aisle),
    aisle = fct_reorder(aisle, n)
  ) %>% 
  ggplot(aes(x = aisle, y = n)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    title = "Number of items ordered in each aisle",
    x = "Aisle",
    y = "Number of items"
  )
```

**1.3 Popular product in aisles**

```{r}
aisle_df = 
  instacart %>% 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>% 
  group_by(aisle) %>% 
  count(product_name) %>% 
  arrange(aisle, desc(n)) %>% 
  filter(row_number() == 1) %>% 
  rename(most_popular_product = product_name, ordered_times = n) %>% 
  knitr::kable(digits = 2)

aisle_df
```

**1.4 Product and day** 

```{r}
day_df = 
  instacart %>% 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>% 
  group_by(product_name, order_dow) %>% 
  summarize(
    mean_hour = mean(order_hour_of_day)
  ) %>% 
  mutate(
    order_dow = recode(order_dow, "0" = "Sunday", "1" = "Monday", "2" = "Tuesday", "3" = "Wednesday", "4" = "Thursday", "5" = "Friday", "6" = "Saturday")
  ) %>% 
  pivot_wider(
    names_from = "order_dow",
    values_from = "mean_hour"
  ) %>% 
  knitr::kable(digits = 2)

day_df
```


## Problem 2

Load the data set `BRFSS`.
```{r}
data("brfss_smart2010")
```

**2.1 Data cleaning**

```{r}
tidy_brfss = 
  brfss_smart2010 %>% 
  janitor::clean_names() %>% 
  filter(topic == "Overall Health") %>% 
  drop_na(response) %>% ## Except 5 responses, there are only null value, so we use drop_na.
  mutate(
    response = factor(response),
    response = fct_relevel(response, "Poor", "Fair", "Good", "Very good", "Excellent")
  ) %>% 
  arrange(response)

tidy_brfss
```

**2.2 2002 locations**

```{r}
state_obs_2002 = 
  tidy_brfss %>% 
  filter(year == "2002") %>% 
  group_by(locationabbr) %>% 
  summarize(county = n_distinct(locationdesc)) %>% 
  filter(county >= 7) %>% 
  knitr::kable(aligh = "c")

state_obs_2002
```

In 2002, 6 states including CT, FL, MA, NC, NJ and PA were observed at 7 or more locations.

```{r}
state_obs_2010 = 
  tidy_brfss %>% 
  filter(year == "2010") %>% 
  group_by(locationabbr) %>% 
  summarize(county = n_distinct(locationdesc)) %>% 
  filter(county >= 7) %>% 
  knitr::kable(aligh = "c")

state_obs_2010
```

In 2010, 14 states including CA, CO, FL, MA, MD, NC, NE, NJ, NY, OH, PA, SC, TX and WA were observed at 7 or more locations.

**2.3 Excellent plot**

```{r message=FALSE}
tidy_brfss %>% 
  filter(response == "Excellent") %>% 
  group_by(year, locationabbr) %>% 
  summarize(
    state_mean = mean(data_value, na.rm = TRUE)
  ) %>% 
  ggplot(aes(x = year, y = state_mean, color = locationabbr)) +
  geom_line() +
  theme(legend.position = "right") +
  viridis::scale_color_viridis(
    name = "state",
    discrete = TRUE
  ) +
  labs(
    title = "Spaghetti plot within each state over time",
    x = "Year",
    y = "Average value in each state"
  )
```

**2.4 NY state**

```{r}
tidy_brfss %>% 
  filter(
    locationabbr == "NY",
    year %in% c(2006, 2010)
  ) %>% 
  rename(state = locationabbr, county = locationdesc) %>% 
  mutate(county = substring(county, 6)) %>% 
  group_by(year, county) %>% 
  ggplot(aes(x = response, y = data_value, fill = county)) +
  geom_col(position = "dodge") +
  facet_grid(. ~ year) +
  labs(
    title = "Value for responses among locations in NY for 2006 and 2010",
    x = "Response",
    y = "Data value for responses"
  ) 
```

